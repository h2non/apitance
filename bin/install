#!/usr/bin/env bash

version=$1
os=`uname`

if [ -z $version ]; then
  echo "Missing required version argument" && exit 1
fi

if [[ "$os" == 'Linux' ]]; then
   platform='linux'
elif [[ "$os" == 'Darwin' ]]; then
   platform='darwin'
else
  echo "Unsupported operative system. Only Linux and OSX are supported" && exit 1
fi

if [ `uname -m` != 'x86_64' ]; then
  echo "Unsupported processor architecture. Only x64 is supported" && exit 1
fi

if [ -d "$HOME/.apitance" ]; then
  echo "Another Apitance installation was found in $HOME/.apitance"
  echo "Remove it to continue..."
  exit 1
fi

echo "Downloading Apitance v.$version"
echo

download="https://github.com/h2non/apitance/releases/download/$version/apitance-$version-$platform-x64.nar"
curl -k -L $download -o apitance.nar
if [ $? -ne 0 ]; then
  echo "Error while downloading binary..." && exit 1
fi

bash apitance.nar extract -o $HOME/.apitance
ln -s $HOME/.apitance/bin/apitance /usr/bin/apitance

rm -f apitance.nar
rm -rf .nar

echo
echo "Installation completed"
echo
echo "To getting started simply run:"
echo "apitance --help"
echo
echo "Enjoy!"
