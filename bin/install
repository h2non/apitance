#!/usr/bin/env bash

version=0.1.0-beta.1
os=`uname`

if [[ "$os" == 'Linux' ]]; then
   platform='linux'
elif [[ "$os" == 'Darwin' ]]; then
   platform='darwin'
else
  echo "Unsupported operative system. Only Linux and OSX are supported" && exit 1
fi

if [ `uname -m` != 'x86_64' ]; then
  echo "Unsupported processor architecture. Only x64 is supported" && exit 1
fi

if [ -d "$HOME/.apitance" ]; then
  echo "Another Apitance installation was found in $HOME/.apitance"
  echo "Remove it to continue..."
  exit 1
fi

echo "Downloading Apitance v.$version"
echo

download="https://github.com/h2non/apitance/releases/download/$version/apitance-$version-$platform-x64.nar"
curl -k -L $download -o apitance.nar

if [ $? != 0 ]; then
  echo "Error while downloading binary..." && exit 1
fi

bash apitance.nar extract -o $HOME/.apitance
mv .nar/bin/node $HOME/.apitance/bin

echo "#!/usr/bin/env bash"     >  $HOME/.apitance/bin/run
echo 'script="$(readlink ${BASH_SOURCE[0]})"' >> $HOME/.apitance/bin/run
echo 'base="$(dirname $script)"' >> $HOME/.apitance/bin/run
echo 'node $base/apitance $*' >> $HOME/.apitance/bin/run

if [ -f /usr/bin/apitance ]; then
  rm -f /usr/bin/apitance
fi

ln -s $HOME/.apitance/bin/run /usr/bin/apitance
chmod +x $HOME/.apitance/bin/apitance
chmod +x /usr/bin/apitance

rm -f apitance.nar
rm -rf .nar

echo
echo "Installation completed"
echo
echo "To getting started simply run:"
echo "apitance --help"
echo
echo "Enjoy!"
